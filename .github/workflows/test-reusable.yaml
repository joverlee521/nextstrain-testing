name: Reusable

on:
  workflow_call:
    inputs:
      ref:
        type: string
        required: true
      env:
        type: string
        required: false
      runtime-envvar-names:
        type: string
        required: false

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          repository: joverlee521/nextstrain-testing
          ref: ${{ inputs.ref }}

      - run: ./bin/hello-world

      - run: ./bin/hello-new-world

      - name: local-fix
        run: |
          # Hack to get setup-python to work on act
          # (see https://github.com/nektos/act/issues/251)
          if [ ! -f "/etc/lsb-release" ] ; then
            echo "DISTRIB_RELEASE=18.04" > /etc/lsb-release
          fi

      - uses: nextstrain/.github/actions/setup-nextstrain-cli@master
        with:
          runtime: conda

      - name: Install envdir
        shell: nextstrain shell . {0}
        run: pip install envdir

      - if: inputs.env
        name: Set environment variables
        env:
          env: ${{ inputs.env }}
        run: >
          # shellcheck disable=SC2154

          echo "$env"
          | yq --output-format json .
          | jq --raw-output '
              to_entries
            | map(if .value|startswith("secrets") then .value="${{ "+.value+" }}" else . end)
            | map("\(.key)<<__EOF__\n\(.value)\n__EOF__")
            | join("\n")
          '
          | tee -a "$GITHUB_ENV"

      - name: Create env.d
        run: mkdir env.d

      - name: Add test envvar
        run: |
          ./bin/write-env env.d ${{ inputs.runtime-envvar-names }}

      - name: Run build
        run: |
          nextstrain build \
            --exec env . \
            envdir env.d printenv ${{ inputs.runtime-envvar-names }}

      - name: Check Augur
        shell: nextstrain shell . {0}
        run: augur --version
