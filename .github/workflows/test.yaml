name: test

on:
  push:
    paths:
      - .github/workflows/test.yaml

  workflow_dispatch:
    inputs:
      boolean_input:
        description: Test boolean input
        type: boolean
        default: true
        required: false

env:
  EMPTY_STRING: ""
  NON_EMPTY_STRING: "hello"
  BOOLEAN_INPUT: ${{ inputs.boolean_input }}
  TEST_BOOLEAN: ${{ github.event_name != 'workflow_dispatch' && true || inputs.boolean_input }}

jobs:
  test:
    runs-on: ubuntu-latest
    outputs:
      ref_matrix: ${{ steps.ref_matrix.outputs.ref_matrix }}
    steps:
      - if: null
        run: echo "Null truthy"

      - if: env.EMPTY_STRING
        run: echo "Empty string truthy"

      - if: env.EMPTY_STRING == ''
        run: echo "Compared empty string truthy"

      - if: env.NON_EMPTY_STRING != ''
        run: echo "Compared non empty string truthy"

      - run: |
          echo "boolean input: $BOOLEAN_INPUT"
          echo "test boolean: $TEST_BOOLEAN"

      - run: |
          echo "RESOURCE_INDEX=s3://nextstrain-inventories/resources/v1.json.gz" | tee -a "$GITHUB_ENV"

      - env:
          TEST: ${{ startsWith(env.RESOURCE_INDEX, 's3://') }}
        run:
          echo $TEST

      - id: ref_matrix
        run: |
          jq_filter='{"ref": [ env.RESOURCE_INDEX ]}'
          ref_matrix=$(jq -c --null-input "$jq_filter")
          echo "ref_matrix=$ref_matrix" | tee -a "$GITHUB_OUTPUT"

      - env:
          TEST: ${{ fromJSON(steps.ref_matrix.outputs.ref_matrix) }}
        run: echo $TEST


  test_matrix:
    needs: [test]
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.test.outputs.ref_matrix) }}
    steps:
      - run: echo ${{ matrix.ref }}
